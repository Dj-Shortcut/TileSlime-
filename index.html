<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tile Slime â€” Food Only</title>

<style>
html, body {
  margin:0;
  padding:0;
  overflow:hidden;
  background:black;
  font-family:system-ui,sans-serif;
}
canvas { display:block; }

#ui {
  position: fixed;
  bottom:40px;
  left:50%;
  transform:translateX(-50%);
  pointer-events:auto;
  z-index:10;
  display:flex;
  justify-content:center;
  align-items:center;
}
</style>
</head>

<body>

<div id="ui">
  <!-- Hidden file input -->
  <input type="file" id="ghost-button" accept="image/*" style="display:none;">

  <!-- SHADCN-STYLE ICON BUTTON (INLINE) -->
  <label for="ghost-button"
    title="Upload image"
    style="
      width:44px;
      height:44px;
      display:flex;
      align-items:center;
      justify-content:center;

      border-radius:12px;
      background:rgba(20,20,20,0.6);
      border:1px solid rgba(255,255,255,0.18);

      color:#e5e7eb;
      cursor:pointer;
      user-select:none;

      box-shadow:
        0 10px 30px rgba(0,0,0,0.45),
        inset 0 1px 0 rgba(255,255,255,0.05);

      backdrop-filter:blur(6px);

      transition:
        background-color 0.2s ease,
        border-color 0.2s ease,
        transform 0.1s ease,
        box-shadow 0.2s ease;
    "
    onmouseenter="this.style.background='rgba(35,35,35,0.8)';this.style.borderColor='rgba(255,255,255,0.28)'"
    onmouseleave="this.style.background='rgba(20,20,20,0.6)';this.style.borderColor='rgba(255,255,255,0.18)'"
    onmousedown="this.style.transform='scale(0.96)'"
    onmouseup="this.style.transform='scale(1)'"
  >
    <!-- lucide-style upload icon -->
    <svg
      width="20" height="20" viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      style="opacity:0.9;"
    >
      <path d="M12 19V5"/>
      <path d="M5 12l7-7 7 7"/>
      <path d="M5 19h14"/>
    </svg>
  </label>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* Parameters */
const AGENTS = 2000;
const SPEED = 1.2;
const TURN = 0.35;
const SENSOR_DIST = 9;
const SENSOR_ANGLE = 0.5;

/* Agents */
const agents = [];
for(let i=0;i<AGENTS;i++){
  let pos;
  if(i < AGENTS/4) pos = {x:0, y:0};
  else if(i < AGENTS/2) pos = {x:canvas.width, y:0};
  else if(i < 3*AGENTS/4) pos = {x:0, y:canvas.height};
  else pos = {x:canvas.width, y:canvas.height};
  agents.push({x:pos.x, y:pos.y, a:Math.random()*Math.PI*2});
}

/* Sine pulse */
const BASE_STRENGTH = 1.0;
const AMPLITUDE = 1.0;
const SINE_FREQ = 1.5;

/* Food canvas */
const imgCanvas = document.createElement("canvas");
const imgCtx = imgCanvas.getContext("2d");
let foodData = null, foodW = 0, foodH = 0;

/* Initial text food */
function createTextFood(){
  const text = "DROP IMAGE";
  const fontSize = Math.floor(canvas.width / 6);

  imgCanvas.width = canvas.width;
  imgCanvas.height = canvas.height;
  imgCtx.clearRect(0,0,canvas.width,canvas.height);

  imgCtx.fillStyle = "white";
  imgCtx.font = `${fontSize}px system-ui`;
  imgCtx.textAlign = "center";
  imgCtx.textBaseline = "middle";
  imgCtx.fillText(text, canvas.width/2, canvas.height/2);

  const imgData = imgCtx.getImageData(0,0,canvas.width,canvas.height);
  foodData = detectEdges(imgData);
  foodW = canvas.width;
  foodH = canvas.height;

  for(let i=0;i<foodData.length;i++) foodData[i] *= 2;
}
createTextFood();

/* Load image */
function loadImage(file){
  const img = new Image();
  img.onload = () => {
    const scale = Math.min(canvas.width/img.width, canvas.height/img.height);
    const w = img.width * scale;
    const h = img.height * scale;
    const x = (canvas.width - w) / 2;
    const y = (canvas.height - h) / 2;

    imgCanvas.width = canvas.width;
    imgCanvas.height = canvas.height;
    imgCtx.clearRect(0,0,canvas.width,canvas.height);
    imgCtx.drawImage(img, x, y, w, h);

    const imgData = imgCtx.getImageData(0,0,canvas.width,canvas.height);
    foodData = detectEdges(imgData);
    foodW = canvas.width;
    foodH = canvas.height;

    for(let i=0;i<foodData.length;i++) foodData[i] *= 2;
  };
  img.src = URL.createObjectURL(file);
}

/* Edge detection */
function detectEdges(img){
  const data = img.data;
  const out = new Float32Array(img.width * img.height);

  for(let y=1;y<img.height-1;y++){
    for(let x=1;x<img.width-1;x++){
      const i = (y*img.width + x) * 4;
      const lum = i => data[i]*0.299 + data[i+1]*0.587 + data[i+2]*0.114;
      const gx = lum(i+4) - lum(i-4);
      const gy = lum(i+img.width*4) - lum(i-img.width*4);
      out[y*img.width + x] = Math.sqrt(gx*gx + gy*gy);
    }
  }
  return out;
}

/* Sense */
function sense(x,y){
  if(x < 0) x += canvas.width;
  if(y < 0) y += canvas.height;
  if(x >= canvas.width) x -= canvas.width;
  if(y >= canvas.height) y -= canvas.height;

  if(foodData){
    return foodData[(y|0)*foodW + (x|0)] || 0;
  }
  return 0;
}

/* Main loop */
function update(){
  const t = performance.now() * 0.001;
  const FOOD_STRENGTH = BASE_STRENGTH + AMPLITUDE * Math.sin(2*Math.PI*SINE_FREQ*t);

  ctx.fillStyle = "rgba(0,0,0,0.025)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  for(const p of agents){
    const c = sense(p.x + Math.cos(p.a)*SENSOR_DIST, p.y + Math.sin(p.a)*SENSOR_DIST);
    const l = sense(p.x + Math.cos(p.a-SENSOR_ANGLE)*SENSOR_DIST, p.y + Math.sin(p.a-SENSOR_ANGLE)*SENSOR_DIST);
    const r = sense(p.x + Math.cos(p.a+SENSOR_ANGLE)*SENSOR_DIST, p.y + Math.sin(p.a+SENSOR_ANGLE)*SENSOR_DIST);

    if(l>c && l>r) p.a -= TURN;
    else if(r>c && r>l) p.a += TURN;
    else p.a += (Math.random()-0.5)*0.08;

    p.x += Math.cos(p.a)*SPEED;
    p.y += Math.sin(p.a)*SPEED;

    if(p.x < 0) p.x += canvas.width;
    if(p.y < 0) p.y += canvas.height;
    if(p.x >= canvas.width) p.x -= canvas.width;
    if(p.y >= canvas.height) p.y -= canvas.height;

    const s = sense(p.x,p.y) * FOOD_STRENGTH;

    let color = "rgba(80,120,255,0.35)";
    if(s>50) color="rgba(80,200,120,0.45)";
    if(s>120) color="rgba(255,220,120,0.55)";
    if(s>200) color="rgba(255,120,80,0.75)";

    ctx.fillStyle = color;
    ctx.fillRect(p.x-1,p.y-1,3,3);
  }

  requestAnimationFrame(update);
}
update();

/* Upload handler */
document.getElementById("ghost-button").addEventListener("change", e=>{
  if(e.target.files[0]) loadImage(e.target.files[0]);
});
</script>

</body>
</html>
