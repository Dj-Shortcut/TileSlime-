<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tile Slime — Bright Photo Food</title>
<style>
html, body {
  margin:0; padding:0; overflow:hidden; background:#0b0e1a; font-family:system-ui,sans-serif;
}
#ui {
  position: fixed; top: 10px; left: 10px; z-index:10; color:#eaeaf0;
}
input {
  background:#1a1f3a; color:white; border:none; padding:6px; border-radius:6px;
}
canvas { display:block; }
</style>
</head>
<body>

<div id="ui">
  <input type="file" id="upload" accept="image/*">
  <div style="opacity:.7;margin-top:4px">Upload image → edges → food → behavior</div>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
function resize(){canvas.width=window.innerWidth; canvas.height=window.innerHeight;}
window.addEventListener("resize", resize); resize();

/* Parameters */
const AGENTS = 2000;
const SPEED = 1.2;
const TURN = 0.35;
const SENSOR_DIST = 9;
const SENSOR_ANGLE = 0.5;
const DECAY = 0.975; // iets sneller fading voor contrast

/* Agents */
const agents=[];
for(let i=0;i<AGENTS;i++){
  agents.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, a:Math.random()*Math.PI*2});
}

/* Sine pulse */
const BASE_STRENGTH=1.0;
const AMPLITUDE=1.0;
const SINE_FREQ=1.5; // pulse snelheid

/* Photo food */
const imgCanvas=document.createElement("canvas");
const imgCtx=imgCanvas.getContext("2d");
let foodData=null, foodW=0, foodH=0;

function loadImage(file){
  const img=new Image();
  img.onload=()=>{
    imgCanvas.width=canvas.width; imgCanvas.height=canvas.height;
    imgCtx.drawImage(img,0,0,imgCanvas.width,imgCanvas.height);
    const imgData=imgCtx.getImageData(0,0,imgCanvas.width,imgCanvas.height);
    foodData=detectEdges(imgData); foodW=imgCanvas.width; foodH=imgCanvas.height;

    // versterk edges voor beter zicht
    for(let k=0;k<foodData.length;k++) foodData[k] *= 2; // double brightness
  };
  img.src=URL.createObjectURL(file);
}

function detectEdges(img){
  const data=img.data; const out=new Float32Array(img.width*img.height);
  for(let y=1;y<img.height-1;y++){
    for(let x=1;x<img.width-1;x++){
      const i=(y*img.width+x)*4;
      const lum=i=>data[i]*0.299+data[i+1]*0.587+data[i+2]*0.114;
      const gx=lum(i+4)-lum(i-4);
      const gy=lum(i+img.width*4)-lum(i-img.width*4);
      out[y*img.width+x]=Math.min(255, Math.sqrt(gx*gx+gy*gy));
    }
  }
  return out;
}

function sense(x,y){
  if(x<0)x=canvas.width; if(y<0)y=canvas.height;
  if(x>=canvas.width)x=0; if(y>=canvas.height)y=0;
  const p=ctx.getImageData(Math.floor(x),Math.floor(y),1,1).data[0];
  if(foodData){
    const fx=Math.floor(x), fy=Math.floor(y);
    const food=foodData[fy*foodW+fx]||0;
    return p+food;
  }
  return p;
}

/* Main loop */
function update(){
  const t=performance.now()*0.001;
  const FOOD_STRENGTH=BASE_STRENGTH+AMPLITUDE*Math.sin(2*Math.PI*SINE_FREQ*t);

  // decay
  ctx.fillStyle="rgba(0,0,0,0.025)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  for(const p of agents){
    const c=sense(p.x+Math.cos(p.a)*SENSOR_DIST, p.y+Math.sin(p.a)*SENSOR_DIST);
    const l=sense(p.x+Math.cos(p.a-SENSOR_ANGLE)*SENSOR_DIST, p.y+Math.sin(p.a-SENSOR_ANGLE)*SENSOR_DIST);
    const r=sense(p.x+Math.cos(p.a+SENSOR_ANGLE)*SENSOR_DIST, p.y+Math.sin(p.a+SENSOR_ANGLE)*SENSOR_DIST);

    if(l>c && l>r) p.a-=TURN;
    else if(r>c && r>l) p.a+=TURN;
    else p.a+=(Math.random()-0.5)*0.08;

    p.x+=Math.cos(p.a)*SPEED;
    p.y+=Math.sin(p.a)*SPEED;

    if(p.x<0)p.x+=canvas.width; if(p.y<0)p.y+=canvas.height;
    if(p.x>canvas.width)p.x-=canvas.width; if(p.y>canvas.height)p.y-=canvas.height;

    const s=sense(p.x,p.y)*FOOD_STRENGTH;
    let color="rgba(80,120,255,0.35)";
    if(s>50) color="rgba(80,200,120,0.45)";
    if(s>120) color="rgba(255,220,120,0.55)";
    if(s>200) color="rgba(255,120,80,0.75)";

    // glow effect
    ctx.fillStyle=color;
    ctx.fillRect(p.x-1,p.y-1,3,3);
  }

  requestAnimationFrame(update);
}

update();

/* Upload handler */
document.getElementById("upload").addEventListener("change", e=>{
  if(e.target.files[0]) loadImage(e.target.files[0]);
});
</script>

</body>
</html>
