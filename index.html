<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tile Slime â€” Food Only</title>
  <!-- fix build -->
<style>
html, body {
  margin:0; padding:0; overflow:hidden; background:black; font-family:system-ui,sans-serif;
}
canvas { display:block; }

#ui {
  position: fixed; bottom:40px; left:50%; transform:translateX(-50%);
  pointer-events:auto; z-index:10; display:flex; justify-content:center; align-items:center; flex-direction:column;
}
</style>
</head>
<body>

<div id="ui">
  <!-- Hidden file input -->
  <input type="file" id="ghost-button" accept="image/*" style="display:none;">

  <!-- Styled label as ghost button, 50% bigger -->
  <label for="ghost-button"
    style="
      width:105px; height:105px; border-radius:50%;
      display:flex; justify-content:center; align-items:center;
      border:1px solid #dcdcdc; background:#2c2c2c;
      cursor:pointer;
      box-sizing:border-box;
      position:relative;
    "
    title="Drop image"
  >
    <!-- Plus sign -->
    <span style="
      position:relative; display:block;
      width:45px; height:45px;
    ">
      <span style="
        position:absolute; top:50%; left:50%;
        width:6px; height:45px; background:#dcdcdc;
        transform:translate(-50%,-50%);
      "></span>
      <span style="
        position:absolute; top:50%; left:50%;
        width:45px; height:6px; background:#dcdcdc;
        transform:translate(-50%,-50%);
      "></span>
    </span>
  </label>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
function resize(){canvas.width=window.innerWidth; canvas.height=window.innerHeight;}
window.addEventListener("resize", resize); resize();

/* Parameters */
const AGENTS = 2000;
const SPEED = 1.2;
const TURN = 0.35;
const SENSOR_DIST = 9;
const SENSOR_ANGLE = 0.5;

/* Agents start from four corners */
const agents=[];
for(let i=0;i<AGENTS;i++){
  let pos;
  if(i<AGENTS/4) pos={x:0, y:0};
  else if(i<AGENTS/2) pos={x:canvas.width, y:0};
  else if(i<3*AGENTS/4) pos={x:0, y:canvas.height};
  else pos={x:canvas.width, y:canvas.height};
  agents.push({x:pos.x, y:pos.y, a:Math.random()*Math.PI*2});
}

/* Sine pulse */
const BASE_STRENGTH=1.0;
const AMPLITUDE=1.0;
const SINE_FREQ=1.5;

/* Photo food */
const imgCanvas=document.createElement("canvas");
const imgCtx=imgCanvas.getContext("2d");
let foodData=null, foodW=0, foodH=0;

/* Draw "DROP IMAGE" text into canvas as initial food */
function createTextFood(){
  const text = "DROP IMAGE";
  const fontSize = Math.floor(canvas.width / 6); // big letters
  imgCanvas.width = canvas.width;
  imgCanvas.height = canvas.height;
  imgCtx.clearRect(0,0,canvas.width,canvas.height);
  imgCtx.fillStyle = "white";
  imgCtx.font = `${fontSize}px system-ui`;
  imgCtx.textAlign = "center";
  imgCtx.textBaseline = "middle";
  imgCtx.fillText(text, canvas.width/2, canvas.height/2);
  const imgData = imgCtx.getImageData(0,0,canvas.width,canvas.height);
  foodData = detectEdges(imgData);
  foodW = canvas.width;
  foodH = canvas.height;
  for(let k=0;k<foodData.length;k++) foodData[k]*=2;
}
createTextFood();

/* Upload & Image */
function loadImage(file){
  const img=new Image();
  img.onload=()=>{
    let scale=Math.min(canvas.width/img.width, canvas.height/img.height);
    let w=img.width*scale, h=img.height*scale;
    let x=(canvas.width-w)/2, y=(canvas.height-h)/2;
    imgCanvas.width=canvas.width; imgCanvas.height=canvas.height;
    imgCtx.clearRect(0,0,canvas.width,canvas.height);
    imgCtx.drawImage(img,x,y,w,h);
    const imgData=imgCtx.getImageData(0,0,canvas.width,canvas.height);
    foodData=detectEdges(imgData); 
    foodW=canvas.width; foodH=canvas.height;
    for(let k=0;k<foodData.length;k++) foodData[k]*=2;
  };
  img.src=URL.createObjectURL(file);
}

/* Edge detection */
function detectEdges(img){
  const data=img.data; 
  const out=new Float32Array(img.width*img.height);
  for(let y=1;y<img.height-1;y++){
    for(let x=1;x<img.width-1;x++){
      const i=(y*img.width+x)*4;
      const lum=i=>data[i]*0.299+data[i+1]*0.587+data[i+2]*0.114;
      const gx=lum(i+4)-lum(i-4);
      const gy=lum(i+img.width*4)-lum(i-img.width*4);
      out[y*img.width+x]=Math.min(255, Math.sqrt(gx*gx+gy*gy));
    }
  }
  return out;
}

/* Sense */
function sense(x,y){
  if(x<0)x=canvas.width; if(y<0)y=canvas.height;
  if(x>=canvas.width)x=0; if(y>=canvas.height)y=0;
  if(foodData){
    const fx=Math.floor(x), fy=Math.floor(y);
    return foodData[fy*foodW+fx]||0;
  }
  return 0;
}

/* Main loop */
function update(){
  const t=performance.now()*0.001;
  const FOOD_STRENGTH=BASE_STRENGTH+AMPLITUDE*Math.sin(2*Math.PI*SINE_FREQ*t);

  ctx.fillStyle="rgba(0,0,0,0.025)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  for(const p of agents){
    const c=sense(p.x+Math.cos(p.a)*SENSOR_DIST, p.y+Math.sin(p.a)*SENSOR_DIST);
    const l=sense(p.x+Math.cos(p.a-SENSOR_ANGLE)*SENSOR_DIST, p.y+Math.sin(p.a-SENSOR_ANGLE)*SENSOR_DIST);
    const r=sense(p.x+Math.cos(p.a+SENSOR_ANGLE)*SENSOR_DIST, p.y+Math.sin(p.a+SENSOR_ANGLE)*SENSOR_DIST);

    if(l>c && l>r) p.a-=TURN;
    else if(r>c && r>l) p.a+=TURN;
    else p.a+=(Math.random()-0.5)*0.08;

    p.x+=Math.cos(p.a)*SPEED;
    p.y+=Math.sin(p.a)*SPEED;

    if(p.x<0)p.x+=canvas.width; if(p.y<0)p.y+=canvas.height;
    if(p.x>canvas.width)p.x-=canvas.width; if(p.y>canvas.height)p.y-=canvas.height;

    const s=sense(p.x,p.y)*FOOD_STRENGTH;
    let color="rgba(80,120,255,0.35)";
    if(s>50) color="rgba(80,200,120,0.45)";
    if(s>120) color="rgba(255,220,120,0.55)";
    if(s>200) color="rgba(255,120,80,0.75)";

    ctx.fillStyle=color;
    ctx.fillRect(p.x-1,p.y-1,3,3);
  }

  requestAnimationFrame(update);
}
update();

/* Upload handler */
document.getElementById("ghost-button").addEventListener("change", e=>{
  if(e.target.files[0]) loadImage(e.target.files[0]);
});
</script>

</body>
</html>
