<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tile Slime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      overflow: hidden;
      font-family: sans-serif;
    }

    canvas {
      display: block;
    }

    #ui {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(0,0,0,0.6);
      padding: 8px;
      border-radius: 8px;
      color: white;
    }

    #ui input {
      background: #222;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="ui">
  <label>
    Upload image:
    <input type="file" accept="image/*" />
  </label>
</div>

<canvas id="c"></canvas>

<script>
/* ===============================
   CANVAS SETUP
================================ */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);


/* ===============================
   FOOD MAP
================================ */
const foodCanvas = document.createElement("canvas");
const foodCtx = foodCanvas.getContext("2d");

let food = [];
let cols = 0, rows = 0;
const scale = 4;


/* ===============================
   LOAD IMAGE â†’ FOOD
================================ */
function loadImage(src) {
  const img = new Image();
  img.crossOrigin = "anonymous"; // prevent CORS issues on GitHub Pages
  img.onload = () => buildFood(img);
  img.src = src;
}

function buildFood(img) {
  foodCanvas.width = Math.floor(img.width / scale);
  foodCanvas.height = Math.floor(img.height / scale);

  foodCtx.drawImage(img, 0, 0, foodCanvas.width, foodCanvas.height);

  const data = foodCtx.getImageData(0, 0, foodCanvas.width, foodCanvas.height).data;

  cols = foodCanvas.width;
  rows = foodCanvas.height;
  food = new Float32Array(cols * rows);

  for (let i = 0; i < food.length; i++) {
    const r = data[i * 4];
    const g = data[i * 4 + 1];
    const b = data[i * 4 + 2];
    food[i] = (r + g + b) / 765;
  }

  initAgents();
  requestAnimationFrame(loop); // start animation pas als image klaar is
}


/* ===============================
   SLIME AGENTS
================================ */
const agents = [];
const AGENT_COUNT = 3000;

function initAgents() {
  agents.length = 0;
  for (let i = 0; i < AGENT_COUNT; i++) {
    agents.push({
      x: Math.random() * cols,
      y: Math.random() * rows,
      a: Math.random() * Math.PI * 2
    });
  }
}


/* ===============================
   PARAMETERS
================================ */
const senseDist = 4;
const senseAngle = 0.5;
const turnSpeed = 0.3;
const stepSize = 0.7;


/* ===============================
   MAIN LOOP
================================ */
function loop() {
  ctx.fillStyle = "rgba(0,0,0,0.15)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  if (!food.length) {
    requestAnimationFrame(loop);
    return;
  }

  ctx.save();
  ctx.translate(
    canvas.width / 2 - cols * scale / 2,
    canvas.height / 2 - rows * scale / 2
  );
  ctx.scale(scale, scale);

  ctx.strokeStyle = "rgba(0,255,200,0.8)";
  ctx.lineWidth = 0.3;

  for (const a of agents) {
    function sample(angle) {
      const sx = Math.floor(a.x + Math.cos(a.a + angle) * senseDist);
      const sy = Math.floor(a.y + Math.sin(a.a + angle) * senseDist);
      if (sx < 0 || sy < 0 || sx >= cols || sy >= rows) return 0;
      return food[sx + sy * cols];
    }

    const f = sample(0);
    const l = sample(-senseAngle);
    const r = sample(senseAngle);

    if (l > f && l > r) a.a -= turnSpeed;
    else if (r > f && r > l) a.a += turnSpeed;

    const px = a.x;
    const py = a.y;

    a.x += Math.cos(a.a) * stepSize;
    a.y += Math.sin(a.a) * stepSize;

    if (a.x < 0) a.x += cols;
    if (a.y < 0) a.y += rows;
    if (a.x >= cols) a.x -= cols;
    if (a.y >= rows) a.y -= rows;

    ctx.beginPath();
    ctx.moveTo(px, py);
    ctx.lineTo(a.x, a.y);
    ctx.stroke();
  }

  ctx.restore();
  requestAnimationFrame(loop);
}


/* ===============================
   IMAGE UPLOAD HANDLER
================================ */
document.querySelector("input").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => loadImage(ev.target.result);
  reader.readAsDataURL(file);
});


/* ===============================
   START DEFAULT IMAGE
================================ */
loadImage("mushroom.png"); // zet mushroom.png in root van je repo
</script>

</body>
</html>
